<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSRS Guild Tracker</title>
  <meta name="description" content="Track your Old School RuneScape guild's progress with color-coded skill tiers, leaderboards, and goals.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    :root {
      --bg-dark: #0f1115;
      --bg-card: #1a1d24;
      --bg-card-hover: #22262f;
      --border: #2a2f3a;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent: #f59e0b;
      --accent-hover: #fbbf24;
      --success: #22c55e;
      --tier-99: #22c55e;
      --tier-90: #e879f9;
      --tier-80: #fb7185;
      --tier-70: #fb923c;
      --tier-60: #fbbf24;
      --tier-50: #a3e635;
      --tier-40: #22d3ee;
      --tier-30: #2dd4bf;
      --tier-20: #60a5fa;
      --tier-10: #a78bfa;
  <script type="text/babel">
const { useState, useEffect, createContext, useContext } = React;

// ============================================
// CONSTANTS & UTILITIES
// ============================================

const SKILLS = [
  'attack', 'defence', 'strength', 'hitpoints', 'ranged', 'prayer', 'magic',
  'cooking', 'woodcutting', 'fletching', 'fishing', 'firemaking', 'crafting', 'smithing',
  'mining', 'herblore', 'agility', 'thieving', 'slayer', 'farming', 'runecrafting',
  'hunter', 'construction'
];

const SKILL_DISPLAY_NAMES = {
  attack: 'Attack', defence: 'Defence', strength: 'Strength', hitpoints: 'Hitpoints',
  ranged: 'Ranged', prayer: 'Prayer', magic: 'Magic', cooking: 'Cooking',
  woodcutting: 'Woodcutting', fletching: 'Fletching', fishing: 'Fishing',
  firemaking: 'Firemaking', crafting: 'Crafting', smithing: 'Smithing',
  mining: 'Mining', herblore: 'Herblore', agility: 'Agility', thieving: 'Thieving',
  slayer: 'Slayer', farming: 'Farming', runecrafting: 'Runecraft',
  hunter: 'Hunter', construction: 'Construction'
};

const getLevelTier = (level) => {
  if (level === 99) return { bg: '#22c55e', border: '#16a34a', text: '#052e16', glow: 'rgba(34, 197, 94, 0.3)' };
  if (level >= 90) return { bg: '#e879f9', border: '#c026d3', text: '#4a044e', glow: 'rgba(232, 121, 249, 0.3)' };
  if (level >= 80) return { bg: '#fb7185', border: '#e11d48', text: '#4c0519', glow: 'rgba(251, 113, 133, 0.3)' };
  if (level >= 70) return { bg: '#fb923c', border: '#ea580c', text: '#431407', glow: 'rgba(251, 146, 60, 0.3)' };
  if (level >= 60) return { bg: '#fbbf24', border: '#d97706', text: '#451a03', glow: 'rgba(251, 191, 36, 0.3)' };
  if (level >= 50) return { bg: '#a3e635', border: '#65a30d', text: '#1a2e05', glow: 'rgba(163, 230, 53, 0.3)' };
  if (level >= 40) return { bg: '#22d3ee', border: '#0891b2', text: '#083344', glow: 'rgba(34, 211, 238, 0.3)' };
  if (level >= 30) return { bg: '#2dd4bf', border: '#0d9488', text: '#042f2e', glow: 'rgba(45, 212, 191, 0.3)' };
  if (level >= 20) return { bg: '#60a5fa', border: '#2563eb', text: '#172554', glow: 'rgba(96, 165, 250, 0.3)' };
  if (level >= 10) return { bg: '#a78bfa', border: '#7c3aed', text: '#2e1065', glow: 'rgba(167, 139, 250, 0.3)' };
  return { bg: '#94a3b8', border: '#64748b', text: '#1e293b', glow: 'rgba(148, 163, 184, 0.2)' };
};

const formatNumber = (num) => {
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num?.toLocaleString() || '0';
};

// ============================================
// API FUNCTIONS (WiseOldMan)
// ============================================

const WOM_API = 'https://api.wiseoldman.net/v2';

const api = {
  async getGroup(groupId) {
    const res = await fetch(`${WOM_API}/groups/${groupId}`);
    if (!res.ok) throw new Error('Group not found');
    return res.json();
  },
  
  async getGroupMembers(groupId) {
    const res = await fetch(`${WOM_API}/groups/${groupId}/members`);
    if (!res.ok) throw new Error('Could not fetch members');
    return res.json();
  },
  
  async getGroupHiscores(groupId, metric = 'overall') {
    const res = await fetch(`${WOM_API}/groups/${groupId}/hiscores?metric=${metric}`);
    if (!res.ok) throw new Error('Could not fetch hiscores');
    return res.json();
  },
  
  async getGroupCompetitions(groupId) {
    const res = await fetch(`${WOM_API}/groups/${groupId}/competitions`);
    if (!res.ok) throw new Error('Could not fetch competitions');
    return res.json();
  },
  
  async getPlayer(username) {
    const res = await fetch(`${WOM_API}/players/${encodeURIComponent(username)}`);
    if (!res.ok) throw new Error('Player not found');
    return res.json();
  },
  
  async searchGroups(name) {
    const res = await fetch(`${WOM_API}/groups?name=${encodeURIComponent(name)}&limit=10`);
    if (!res.ok) throw new Error('Search failed');
    return res.json();
  }
};

// ============================================
// CONTEXT
// ============================================

const GuildContext = createContext(null);

const useGuild = () => useContext(GuildContext);

// ============================================
// LOCAL STORAGE FOR GOALS
// ============================================

const storage = {
  getGoals(groupId) {
    const data = localStorage.getItem(`goals_${groupId}`);
    return data ? JSON.parse(data) : { group: [], individual: {} };
  },
  
  saveGoals(groupId, goals) {
    localStorage.setItem(`goals_${groupId}`, JSON.stringify(goals));
  },
  
  getLastGroup() {
    return localStorage.getItem('last_group_id');
  },
  
  setLastGroup(groupId) {
    localStorage.setItem('last_group_id', groupId);
  }
};

// ============================================
// COMPONENTS
// ============================================

const Spinner = () => (
  <div style={{
    width: '32px',
    height: '32px',
    border: '3px solid var(--border)',
    borderTopColor: 'var(--accent)',
    borderRadius: '50%',
    animation: 'spin 0.8s linear infinite',
  }}>
    <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
  </div>
);

const Card = ({ children, style, hover = false, onClick }) => (
  <div
    onClick={onClick}
    style={{
      backgroundColor: 'var(--bg-card)',
      border: '1px solid var(--border)',
      borderRadius: '12px',
      padding: '20px',
      cursor: onClick ? 'pointer' : 'default',
      transition: 'all 0.2s ease',
      ...(hover && { ':hover': { backgroundColor: 'var(--bg-card-hover)' } }),
      ...style,
    }}
  >
    {children}
  </div>
);

const Button = ({ children, variant = 'primary', size = 'md', onClick, disabled, style }) => {
  const variants = {
    primary: { bg: 'var(--accent)', color: '#000', hover: 'var(--accent-hover)' },
    secondary: { bg: 'var(--bg-card)', color: 'var(--text-primary)', hover: 'var(--bg-card-hover)' },
    ghost: { bg: 'transparent', color: 'var(--text-secondary)', hover: 'var(--bg-card)' },
  };
  const sizes = {
    sm: { padding: '6px 12px', fontSize: '13px' },
    md: { padding: '10px 20px', fontSize: '14px' },
    lg: { padding: '14px 28px', fontSize: '16px' },
  };
  const v = variants[variant];
  const s = sizes[size];
  
  return (
    <button
      onClick={onClick}
      disabled={disabled}
      style={{
        backgroundColor: v.bg,
        color: v.color,
        border: variant === 'secondary' ? '1px solid var(--border)' : 'none',
        borderRadius: '8px',
        fontWeight: '600',
        cursor: disabled ? 'not-allowed' : 'pointer',
        opacity: disabled ? 0.5 : 1,
        transition: 'all 0.2s ease',
        ...s,
        ...style,
      }}
    >
      {children}
    </button>
  );
};

const SkillBadge = ({ skill, level, size = 'md' }) => {
  const tier = getLevelTier(level);
  const sizes = {
    sm: { width: '70px', padding: '6px 8px', fontSize: '11px', levelSize: '18px' },
    md: { width: '90px', padding: '10px 12px', fontSize: '12px', levelSize: '24px' },
    lg: { width: '110px', padding: '14px 16px', fontSize: '13px', levelSize: '32px' },
  };
  const s = sizes[size];
  
  return (
    <div style={{
      backgroundColor: tier.bg,
      border: `2px solid ${tier.border}`,
      borderRadius: '8px',
      padding: s.padding,
      width: s.width,
      textAlign: 'center',
      boxShadow: `0 0 12px ${tier.glow}`,
    }}>
      <div style={{ fontSize: s.fontSize, fontWeight: '600', color: tier.text, marginBottom: '2px' }}>
        {level === 99 && '‚úì '}{SKILL_DISPLAY_NAMES[skill] || skill}
      </div>
      <div style={{ fontSize: s.levelSize, fontWeight: '700', color: tier.text, fontFamily: "'IBM Plex Mono', monospace" }}>
        {level}
      </div>
    </div>
  );
};

const StatCard = ({ label, value, accent = false }) => (
  <div style={{
    backgroundColor: 'var(--bg-card)',
    border: accent ? '2px solid var(--accent)' : '1px solid var(--border)',
    borderRadius: '10px',
    padding: '16px 20px',
  }}>
    <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '4px' }}>{label}</div>
    <div style={{
      fontSize: '28px',
      fontWeight: '700',
      color: accent ? 'var(--accent)' : 'var(--text-primary)',
      fontFamily: "'IBM Plex Mono', monospace",
    }}>
      {value}
    </div>
  </div>
);

const LevelLegend = () => {
  const tiers = [
    { range: '1-9', level: 5 },
    { range: '10-19', level: 15 },
    { range: '20-29', level: 25 },
    { range: '30-39', level: 35 },
    { range: '40-49', level: 45 },
    { range: '50-59', level: 55 },
    { range: '60-69', level: 65 },
    { range: '70-79', level: 75 },
    { range: '80-89', level: 85 },
    { range: '90-98', level: 95 },
    { range: '99', level: 99 },
  ];
  
  return (
    <div style={{
      display: 'flex',
      flexWrap: 'wrap',
      gap: '8px 16px',
      padding: '12px 16px',
      backgroundColor: 'var(--bg-card)',
      borderRadius: '8px',
      border: '1px solid var(--border)',
    }}>
      {tiers.map(({ range, level }) => {
        const tier = getLevelTier(level);
        return (
          <div key={range} style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
            <div style={{
              width: '16px',
              height: '16px',
              backgroundColor: tier.bg,
              border: `2px solid ${tier.border}`,
              borderRadius: '4px',
            }} />
            <span style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{range}</span>
          </div>
        );
      })}
    </div>
  );
};

const Nav = ({ currentPage, setPage }) => {
  const { group } = useGuild();
  const pages = [
    { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
    { id: 'members', label: 'Members', icon: 'üë•' },
    { id: 'leaderboards', label: 'Leaderboards', icon: 'üèÜ' },
    { id: 'goals', label: 'Goals', icon: 'üéØ' },
    { id: 'competitions', label: 'Competitions', icon: '‚öîÔ∏è' },
  ];
  
  return (
    <nav style={{
      backgroundColor: 'var(--bg-card)',
      borderBottom: '1px solid var(--border)',
      padding: '0 24px',
      position: 'sticky',
      top: 0,
      zIndex: 100,
    }}>
      <div style={{
        maxWidth: '1200px',
        margin: '0 auto',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        height: '64px',
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '24px' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
            <span style={{ fontSize: '24px' }}>‚öîÔ∏è</span>
            <span style={{ fontWeight: '700', fontSize: '18px' }}>{group?.name || 'Guild Tracker'}</span>
          </div>
          
          <div style={{ display: 'flex', gap: '4px' }}>
            {pages.map(page => (
              <button
                key={page.id}
                onClick={() => setPage(page.id)}
                style={{
                  padding: '8px 14px',
                  backgroundColor: currentPage === page.id ? 'var(--accent)' : 'transparent',
                  color: currentPage === page.id ? '#000' : 'var(--text-secondary)',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontWeight: '500',
                  fontSize: '14px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                  transition: 'all 0.2s ease',
                }}
              >
                <span>{page.icon}</span>
                <span>{page.label}</span>
              </button>
            ))}
          </div>
        </div>
        
        <button
          onClick={() => {
            localStorage.removeItem('last_group_id');
            window.location.reload();
          }}
          style={{
            padding: '8px 14px',
            backgroundColor: 'transparent',
            color: 'var(--text-muted)',
            border: '1px solid var(--border)',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '13px',
          }}
        >
          Switch Guild
        </button>
      </div>
    </nav>
  );
};

// ============================================
// PAGES
// ============================================

const LandingPage = ({ onJoinGuild }) => {
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [searching, setSearching] = useState(false);
  const [groupId, setGroupId] = useState('');
  const [error, setError] = useState('');
  
  const handleSearch = async () => {
    if (!searchQuery.trim()) return;
    setSearching(true);
    setError('');
    try {
      const results = await api.searchGroups(searchQuery);
      setSearchResults(results);
    } catch (e) {
      setError('Search failed. Try again.');
    }
    setSearching(false);
  };
  
  const handleJoinById = async () => {
    if (!groupId.trim()) return;
    setError('');
    try {
      await onJoinGuild(parseInt(groupId));
    } catch (e) {
      setError('Group not found. Check the ID and try again.');
    }
  };
  
  return (
    <div style={{
      minHeight: '100vh',
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      padding: '40px 20px',
      background: 'radial-gradient(ellipse at top, #1a1d24 0%, #0f1115 70%)',
    }}>
      <div style={{ textAlign: 'center', maxWidth: '600px' }}>
        <div style={{ fontSize: '64px', marginBottom: '16px' }}>‚öîÔ∏è</div>
        <h1 style={{ fontSize: '42px', fontWeight: '700', marginBottom: '12px' }}>
          OSRS Guild Tracker
        </h1>
        <p style={{ fontSize: '18px', color: 'var(--text-secondary)', marginBottom: '40px' }}>
          Track your clan's progress with color-coded skill tiers, leaderboards, goals, and more.
          Powered by WiseOldMan.
        </p>
        
        {/* Search for guild */}
        <div style={{
          backgroundColor: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          padding: '24px',
          marginBottom: '16px',
        }}>
          <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px' }}>
            üîç Search for your guild
          </h3>
          <div style={{ display: 'flex', gap: '8px' }}>
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
              placeholder="Enter guild name..."
              style={{
                flex: 1,
                padding: '12px 16px',
                backgroundColor: 'var(--bg-dark)',
                border: '1px solid var(--border)',
                borderRadius: '8px',
                color: 'var(--text-primary)',
                fontSize: '15px',
              }}
            />
            <Button onClick={handleSearch} disabled={searching}>
              {searching ? '...' : 'Search'}
            </Button>
          </div>
          
          {searchResults.length > 0 && (
            <div style={{ marginTop: '16px', textAlign: 'left' }}>
              {searchResults.map(group => (
                <div
                  key={group.id}
                  onClick={() => onJoinGuild(group.id)}
                  style={{
                    padding: '12px 16px',
                    backgroundColor: 'var(--bg-dark)',
                    borderRadius: '8px',
                    marginBottom: '8px',
                    cursor: 'pointer',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    transition: 'background-color 0.2s',
                  }}
                >
                  <div>
                    <div style={{ fontWeight: '600' }}>{group.name}</div>
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)' }}>
                      {group.memberCount} members
                    </div>
                  </div>
                  <span style={{ color: 'var(--accent)' }}>‚Üí</span>
                </div>
              ))}
            </div>
          )}
        </div>
        
        {/* Or join by ID */}
        <div style={{
          backgroundColor: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          padding: '24px',
        }}>
          <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px' }}>
            üî¢ Or enter your WiseOldMan Group ID
          </h3>
          <div style={{ display: 'flex', gap: '8px' }}>
            <input
              type="text"
              value={groupId}
              onChange={(e) => setGroupId(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && handleJoinById()}
              placeholder="e.g., 1234"
              style={{
                flex: 1,
                padding: '12px 16px',
                backgroundColor: 'var(--bg-dark)',
                border: '1px solid var(--border)',
                borderRadius: '8px',
                color: 'var(--text-primary)',
                fontSize: '15px',
              }}
            />
            <Button onClick={handleJoinById}>Join</Button>
          </div>
          <p style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '12px' }}>
            Find your group ID at <a href="https://wiseoldman.net/groups" target="_blank" rel="noopener">wiseoldman.net/groups</a>
          </p>
        </div>
        
        {error && (
          <div style={{
            marginTop: '16px',
            padding: '12px 16px',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            border: '1px solid rgba(239, 68, 68, 0.3)',
            borderRadius: '8px',
            color: '#ef4444',
          }}>
            {error}
          </div>
        )}
        
        {/* Level legend preview */}
        <div style={{ marginTop: '40px' }}>
          <p style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '12px' }}>
            Color-coded skill progression:
          </p>
          <LevelLegend />
        </div>
      </div>
    </div>
  );
};

const DashboardPage = () => {
  const { group, members } = useGuild();
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    if (members) setLoading(false);
  }, [members]);
  
  if (loading) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', padding: '60px' }}>
        <Spinner />
      </div>
    );
  }
  
  const totalMaxed = members?.filter(m => {
    const skills = m.player?.latestSnapshot?.data?.skills;
    if (!skills) return false;
    return Object.values(skills).filter(s => s.level === 99).length === 23;
  }).length || 0;
  
  const averageTotal = members?.reduce((sum, m) => {
    const overall = m.player?.latestSnapshot?.data?.skills?.overall;
    return sum + (overall?.level || 0);
  }, 0) / (members?.length || 1);
  
  const top5 = [...(members || [])]
    .sort((a, b) => {
      const aLevel = a.player?.latestSnapshot?.data?.skills?.overall?.level || 0;
      const bLevel = b.player?.latestSnapshot?.data?.skills?.overall?.level || 0;
      return bLevel - aLevel;
    })
    .slice(0, 5);
  
  return (
    <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '32px 24px' }}>
      <h1 style={{ fontSize: '28px', fontWeight: '700', marginBottom: '8px' }}>
        Dashboard
      </h1>
      <p style={{ color: 'var(--text-secondary)', marginBottom: '32px' }}>
        Overview of {group?.name}
      </p>
      
      {/* Stats Grid */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
        gap: '16px',
        marginBottom: '32px',
      }}>
        <StatCard label="Total Members" value={members?.length || 0} accent />
        <StatCard label="Maxed Players" value={totalMaxed} />
        <StatCard label="Avg Total Level" value={Math.round(averageTotal)} />
        <StatCard label="Group ID" value={group?.id} />
      </div>
      
      {/* Top 5 and Level Legend */}
      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
        <div style={{
          backgroundColor: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          padding: '20px',
        }}>
          <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px' }}>
            üèÜ Top 5 by Total Level
          </h3>
          {top5.map((member, i) => {
            const overall = member.player?.latestSnapshot?.data?.skills?.overall;
            return (
              <div
                key={member.player?.username}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  padding: '10px 12px',
                  backgroundColor: i === 0 ? 'rgba(245, 158, 11, 0.1)' : 'transparent',
                  borderRadius: '8px',
                  marginBottom: '4px',
                }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <span style={{
                    width: '24px',
                    fontWeight: '700',
                    color: i === 0 ? 'var(--accent)' : 'var(--text-muted)',
                  }}>
                    {i + 1}
                  </span>
                  <span style={{ fontWeight: '500' }}>{member.player?.displayName}</span>
                </div>
                <span style={{
                  fontFamily: "'IBM Plex Mono', monospace",
                  fontWeight: '600',
                  color: 'var(--text-secondary)',
                }}>
                  {overall?.level?.toLocaleString()}
                </span>
              </div>
            );
          })}
        </div>
        
        <div style={{
          backgroundColor: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          padding: '20px',
        }}>
          <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px' }}>
            üé® Level Color Guide
          </h3>
          <LevelLegend />
          <p style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '16px' }}>
            Skills are color-coded by level tier so you can quickly see progress at a glance.
          </p>
        </div>
      </div>
    </div>
  );
};

const MembersPage = ({ setPage, setSelectedPlayer }) => {
  const { members } = useGuild();
  const [sortBy, setSortBy] = useState('overall');
  const [search, setSearch] = useState('');
  
  const filtered = (members || [])
    .filter(m => m.player?.displayName?.toLowerCase().includes(search.toLowerCase()))
    .sort((a, b) => {
      const aSkills = a.player?.latestSnapshot?.data?.skills;
      const bSkills = b.player?.latestSnapshot?.data?.skills;
      const aVal = aSkills?.[sortBy]?.level || 0;
      const bVal = bSkills?.[sortBy]?.level || 0;
      return bVal - aVal;
    });
  
  return (
    <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '32px 24px' }}>
      <h1 style={{ fontSize: '28px', fontWeight: '700', marginBottom: '24px' }}>
        Members ({members?.length || 0})
      </h1>
      
      {/* Filters */}
      <div style={{ display: 'flex', gap: '12px', marginBottom: '24px', flexWrap: 'wrap' }}>
        <input
          type="text"
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          placeholder="Search members..."
          style={{
            padding: '10px 16px',
            backgroundColor: 'var(--bg-card)',
            border: '1px solid var(--border)',
            borderRadius: '8px',
            color: 'var(--text-primary)',
            width: '250px',
          }}
        />
        <select
          value={sortBy}
          onChange={(e) => setSortBy(e.target.value)}
          style={{
            padding: '10px 16px',
            backgroundColor: 'var(--bg-card)',
            border: '1px solid var(--border)',
            borderRadius: '8px',
            color: 'var(--text-primary)',
          }}
        >
          <option value="overall">Sort by Total Level</option>
          {SKILLS.map(skill => (
            <option key={skill} value={skill}>Sort by {SKILL_DISPLAY_NAMES[skill]}</option>
          ))}
        </select>
      </div>
      
      {/* Member Cards */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))',
        gap: '16px',
      }}>
        {filtered.map(member => {
          const skills = member.player?.latestSnapshot?.data?.skills;
          const overall = skills?.overall;
          const maxedCount = skills ? Object.entries(skills).filter(([k, v]) => k !== 'overall' && v.level === 99).length : 0;
          
          return (
            <div
              key={member.player?.username}
              onClick={() => {
                setSelectedPlayer(member.player);
                setPage('player');
              }}
              style={{
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '12px',
                padding: '20px',
                cursor: 'pointer',
                transition: 'all 0.2s ease',
              }}
            >
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '16px' }}>
                <div>
                  <div style={{ fontWeight: '600', fontSize: '18px' }}>{member.player?.displayName}</div>
                  <div style={{ color: 'var(--text-muted)', fontSize: '13px' }}>
                    {member.role || 'Member'}
                  </div>
                </div>
                <div style={{ textAlign: 'right' }}>
                  <div style={{ fontFamily: "'IBM Plex Mono', monospace", fontWeight: '700', fontSize: '20px' }}>
                    {overall?.level?.toLocaleString()}
                  </div>
                  <div style={{ color: 'var(--text-muted)', fontSize: '13px' }}>
                    {maxedCount}/23 maxed
                  </div>
                </div>
              </div>
              
              {/* Mini skill preview */}
              <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                {SKILLS.slice(0, 7).map(skill => {
                  const level = skills?.[skill]?.level || 1;
                  const tier = getLevelTier(level);
                  return (
                    <div
                      key={skill}
                      style={{
                        width: '32px',
                        height: '32px',
                        backgroundColor: tier.bg,
                        border: `1px solid ${tier.border}`,
                        borderRadius: '4px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '11px',
                        fontWeight: '700',
                        color: tier.text,
                      }}
                    >
                      {level}
                    </div>
                  );
                })}
                <div style={{
                  width: '32px',
                  height: '32px',
                  backgroundColor: 'var(--bg-dark)',
                  borderRadius: '4px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '11px',
                  color: 'var(--text-muted)',
                }}>
                  +{SKILLS.length - 7}
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

const PlayerPage = ({ player, setPage }) => {
  if (!player) return null;
  
  const skills = player.latestSnapshot?.data?.skills;
  const overall = skills?.overall;
  const maxedCount = skills ? Object.entries(skills).filter(([k, v]) => k !== 'overall' && v.level === 99).length : 0;
  
  const skillRows = [
    ['attack', 'defence', 'strength', 'hitpoints', 'ranged', 'prayer', 'magic'],
    ['cooking', 'woodcutting', 'fletching', 'fishing', 'firemaking', 'crafting', 'smithing'],
    ['mining', 'herblore', 'agility', 'thieving', 'slayer', 'farming', 'runecrafting'],
    ['hunter', 'construction'],
  ];
  
  return (
    <div style={{ maxWidth: '1000px', margin: '0 auto', padding: '32px 24px' }}>
      <button
        onClick={() => setPage('members')}
        style={{
          background: 'none',
          border: 'none',
          color: 'var(--accent)',
          cursor: 'pointer',
          fontSize: '14px',
          marginBottom: '24px',
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
        }}
      >
        ‚Üê Back to members
      </button>
      
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '32px' }}>
        <div>
          <h1 style={{ fontSize: '32px', fontWeight: '700', marginBottom: '8px' }}>
            {player.displayName}
          </h1>
          <a
            href={`https://wiseoldman.net/players/${player.username}`}
            target="_blank"
            rel="noopener"
            style={{ fontSize: '14px' }}
          >
            View on WiseOldMan ‚Üí
          </a>
        </div>
      </div>
      
      {/* Stats */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',
        gap: '16px',
        marginBottom: '32px',
      }}>
        <StatCard label="Total Level" value={overall?.level?.toLocaleString()} accent />
        <StatCard label="Total XP" value={formatNumber(overall?.experience)} />
        <StatCard label="99s" value={`${maxedCount}/23`} />
        <StatCard label="Combat Level" value={player.combatLevel || '‚Äî'} />
      </div>
      
      {/* Level Legend */}
      <div style={{ marginBottom: '24px' }}>
        <LevelLegend />
      </div>
      
      {/* Skills Grid */}
      <h2 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '16px' }}>Skills</h2>
      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
        {skillRows.map((row, i) => (
          <div key={i} style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
            {row.map(skill => (
              <SkillBadge key={skill} skill={skill} level={skills?.[skill]?.level || 1} />
            ))}
          </div>
        ))}
      </div>
    </div>
  );
};

const LeaderboardsPage = () => {
  const { group, members } = useGuild();
  const [metric, setMetric] = useState('overall');
  
  const sorted = [...(members || [])]
    .map(m => ({
      ...m,
      value: m.player?.latestSnapshot?.data?.skills?.[metric]?.level || 0,
      xp: m.player?.latestSnapshot?.data?.skills?.[metric]?.experience || 0,
    }))
    .sort((a, b) => b.value - a.value || b.xp - a.xp);
  
  return (
    <div style={{ maxWidth: '900px', margin: '0 auto', padding: '32px 24px' }}>
      <h1 style={{ fontSize: '28px', fontWeight: '700', marginBottom: '24px' }}>
        Leaderboards
      </h1>
      
      {/* Metric selector */}
      <div style={{ marginBottom: '24px' }}>
        <select
          value={metric}
          onChange={(e) => setMetric(e.target.value)}
          style={{
            padding: '12px 20px',
            backgroundColor: 'var(--bg-card)',
            border: '1px solid var(--border)',
            borderRadius: '8px',
            color: 'var(--text-primary)',
            fontSize: '15px',
            minWidth: '200px',
          }}
        >
          <option value="overall">Total Level</option>
          {SKILLS.map(skill => (
            <option key={skill} value={skill}>{SKILL_DISPLAY_NAMES[skill]}</option>
          ))}
        </select>
      </div>
      
      {/* Leaderboard table */}
      <div style={{
        backgroundColor: 'var(--bg-card)',
        border: '1px solid var(--border)',
        borderRadius: '12px',
        overflow: 'hidden',
      }}>
        {sorted.map((member, i) => {
          const tier = getLevelTier(member.value);
          return (
            <div
              key={member.player?.username}
              style={{
                display: 'flex',
                alignItems: 'center',
                padding: '16px 20px',
                borderBottom: i < sorted.length - 1 ? '1px solid var(--border)' : 'none',
                backgroundColor: i < 3 ? `rgba(245, 158, 11, ${0.1 - i * 0.03})` : 'transparent',
              }}
            >
              <span style={{
                width: '40px',
                fontWeight: '700',
                fontSize: '18px',
                color: i < 3 ? 'var(--accent)' : 'var(--text-muted)',
              }}>
                {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}
              </span>
              
              <span style={{ flex: 1, fontWeight: '500' }}>
                {member.player?.displayName}
              </span>
              
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '12px',
              }}>
                <span style={{ color: 'var(--text-muted)', fontSize: '13px' }}>
                  {formatNumber(member.xp)} XP
                </span>
                <div style={{
                  backgroundColor: tier.bg,
                  border: `2px solid ${tier.border}`,
                  borderRadius: '6px',
                  padding: '4px 12px',
                  fontWeight: '700',
                  color: tier.text,
                  fontFamily: "'IBM Plex Mono', monospace",
                }}>
                  {member.value}
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

const GoalsPage = () => {
  const { group, members } = useGuild();
  const [goals, setGoals] = useState(() => storage.getGoals(group?.id));
  const [newGoal, setNewGoal] = useState({ skill: 'overall', level: 99, description: '' });
  const [showForm, setShowForm] = useState(false);
  
  useEffect(() => {
    if (group?.id) {
      storage.saveGoals(group.id, goals);
    }
  }, [goals, group?.id]);
  
  const addGroupGoal = () => {
    const goal = {
      id: Date.now(),
      skill: newGoal.skill,
      level: parseInt(newGoal.level),
      description: newGoal.description || `Get ${newGoal.level} ${SKILL_DISPLAY_NAMES[newGoal.skill] || newGoal.skill}`,
      createdAt: new Date().toISOString(),
    };
    setGoals(prev => ({ ...prev, group: [...prev.group, goal] }));
    setNewGoal({ skill: 'overall', level: 99, description: '' });
    setShowForm(false);
  };
  
  const removeGoal = (goalId) => {
    setGoals(prev => ({
      ...prev,
      group: prev.group.filter(g => g.id !== goalId),
    }));
  };
  
  const calculateProgress = (goal) => {
    if (!members) return { completed: 0, total: 0, members: [] };
    
    const completed = members.filter(m => {
      const level = m.player?.latestSnapshot?.data?.skills?.[goal.skill]?.level || 0;
      return level >= goal.level;
    });
    
    return {
      completed: completed.length,
      total: members.length,
      members: completed.map(m => m.player?.displayName),
    };
  };
  
  return (
    <div style={{ maxWidth: '900px', margin: '0 auto', padding: '32px 24px' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
        <h1 style={{ fontSize: '28px', fontWeight: '700' }}>
          Guild Goals
        </h1>
        <Button onClick={() => setShowForm(!showForm)}>
          {showForm ? 'Cancel' : '+ Add Goal'}
        </Button>
      </div>
      
      {/* Add goal form */}
      {showForm && (
        <div style={{
          backgroundColor: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          padding: '20px',
          marginBottom: '24px',
        }}>
          <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px' }}>New Guild Goal</h3>
          <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
            <select
              value={newGoal.skill}
              onChange={(e) => setNewGoal(prev => ({ ...prev, skill: e.target.value }))}
              style={{
                padding: '10px 16px',
                backgroundColor: 'var(--bg-dark)',
                border: '1px solid var(--border)',
                borderRadius: '8px',
                color: 'var(--text-primary)',
              }}
            >
              <option value="overall">Total Level</option>
              {SKILLS.map(skill => (
                <option key={skill} value={skill}>{SKILL_DISPLAY_NAMES[skill]}</option>
              ))}
            </select>
            
            <input
              type="number"
              min="1"
              max="99"
              value={newGoal.level}
              onChange={(e) => setNewGoal(prev => ({ ...prev, level: e.target.value }))}
              placeholder="Level"
              style={{
                padding: '10px 16px',
                backgroundColor: 'var(--bg-dark)',
                border: '1px solid var(--border)',
                borderRadius: '8px',
                color: 'var(--text-primary)',
                width: '100px',
              }}
            />
            
            <input
              type="text"
              value={newGoal.description}
              onChange={(e) => setNewGoal(prev => ({ ...prev, description: e.target.value }))}
              placeholder="Description (optional)"
              style={{
                padding: '10px 16px',
                backgroundColor: 'var(--bg-dark)',
                border: '1px solid var(--border)',
                borderRadius: '8px',
                color: 'var(--text-primary)',
                flex: 1,
                minWidth: '200px',
              }}
            />
            
            <Button onClick={addGroupGoal}>Add Goal</Button>
          </div>
        </div>
      )}
      
      {/* Goals list */}
      {goals.group.length === 0 ? (
        <div style={{
          backgroundColor: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          padding: '40px',
          textAlign: 'center',
          color: 'var(--text-muted)',
        }}>
          <div style={{ fontSize: '48px', marginBottom: '16px' }}>üéØ</div>
          <p>No guild goals yet. Add one to start tracking progress!</p>
        </div>
      ) : (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
          {goals.group.map(goal => {
            const progress = calculateProgress(goal);
            const percentage = (progress.completed / progress.total) * 100;
            const tier = getLevelTier(goal.level);
            
            return (
              <div
                key={goal.id}
                style={{
                  backgroundColor: 'var(--bg-card)',
                  border: '1px solid var(--border)',
                  borderRadius: '12px',
                  padding: '20px',
                }}
              >
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '12px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <div style={{
                      backgroundColor: tier.bg,
                      border: `2px solid ${tier.border}`,
                      borderRadius: '6px',
                      padding: '6px 12px',
                      fontWeight: '700',
                      color: tier.text,
                    }}>
                      {goal.level} {SKILL_DISPLAY_NAMES[goal.skill]}
                    </div>
                    <span style={{ fontWeight: '500' }}>{goal.description}</span>
                  </div>
                  <button
                    onClick={() => removeGoal(goal.id)}
                    style={{
                      background: 'none',
                      border: 'none',
                      color: 'var(--text-muted)',
                      cursor: 'pointer',
                      fontSize: '18px',
                    }}
                  >
                    √ó
                  </button>
                </div>
                
                {/* Progress bar */}
                <div style={{
                  height: '8px',
                  backgroundColor: 'var(--bg-dark)',
                  borderRadius: '4px',
                  overflow: 'hidden',
                  marginBottom: '8px',
                }}>
                  <div style={{
                    height: '100%',
                    width: `${percentage}%`,
                    backgroundColor: percentage === 100 ? 'var(--success)' : 'var(--accent)',
                    transition: 'width 0.3s ease',
                  }} />
                </div>
                
                <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '13px' }}>
                  <span style={{ color: 'var(--text-muted)' }}>
                    {progress.completed}/{progress.total} members ({Math.round(percentage)}%)
                  </span>
                  {progress.completed > 0 && (
                    <span style={{ color: 'var(--text-secondary)' }}>
                      ‚úì {progress.members.slice(0, 3).join(', ')}{progress.members.length > 3 ? ` +${progress.members.length - 3}` : ''}
                    </span>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
};

const CompetitionsPage = () => {
  const { group } = useGuild();
  const [competitions, setCompetitions] = useState([]);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    if (group?.id) {
      api.getGroupCompetitions(group.id)
        .then(setCompetitions)
        .catch(console.error)
        .finally(() => setLoading(false));
    }
  }, [group?.id]);
  
  if (loading) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', padding: '60px' }}>
        <Spinner />
      </div>
    );
  }
  
  const ongoing = competitions.filter(c => new Date(c.startsAt) <= new Date() && new Date(c.endsAt) > new Date());
  const upcoming = competitions.filter(c => new Date(c.startsAt) > new Date());
  const past = competitions.filter(c => new Date(c.endsAt) <= new Date()).slice(0, 5);
  
  const CompCard = ({ comp }) => {
    const start = new Date(comp.startsAt);
    const end = new Date(comp.endsAt);
    const now = new Date();
    const isOngoing = start <= now && end > now;
    const isUpcoming = start > now;
    
    return (
      <a
        href={`https://wiseoldman.net/competitions/${comp.id}`}
        target="_blank"
        rel="noopener"
        style={{
          display: 'block',
          backgroundColor: 'var(--bg-card)',
          border: isOngoing ? '2px solid var(--accent)' : '1px solid var(--border)',
          borderRadius: '12px',
          padding: '20px',
          textDecoration: 'none',
          color: 'inherit',
        }}
      >
        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
          <span style={{ fontWeight: '600' }}>{comp.title}</span>
          {isOngoing && (
            <span style={{
              backgroundColor: 'var(--accent)',
              color: '#000',
              padding: '2px 8px',
              borderRadius: '4px',
              fontSize: '12px',
              fontWeight: '600',
            }}>
              LIVE
            </span>
          )}
        </div>
        <div style={{ color: 'var(--text-muted)', fontSize: '13px' }}>
          {comp.metric} ‚Ä¢ {comp.participantCount} participants
        </div>
        <div style={{ color: 'var(--text-secondary)', fontSize: '13px', marginTop: '4px' }}>
          {isUpcoming ? `Starts ${start.toLocaleDateString()}` : isOngoing ? `Ends ${end.toLocaleDateString()}` : `Ended ${end.toLocaleDateString()}`}
        </div>
      </a>
    );
  };
  
  return (
    <div style={{ maxWidth: '900px', margin: '0 auto', padding: '32px 24px' }}>
      <h1 style={{ fontSize: '28px', fontWeight: '700', marginBottom: '24px' }}>
        Competitions
      </h1>
      
      {competitions.length === 0 ? (
        <div style={{
          backgroundColor: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          padding: '40px',
          textAlign: 'center',
          color: 'var(--text-muted)',
        }}>
          <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚öîÔ∏è</div>
          <p>No competitions found for this group.</p>
          <a
            href="https://wiseoldman.net/competitions/create"
            target="_blank"
            rel="noopener"
            style={{ display: 'inline-block', marginTop: '16px' }}
          >
            Create one on WiseOldMan ‚Üí
          </a>
        </div>
      ) : (
        <>
          {ongoing.length > 0 && (
            <div style={{ marginBottom: '32px' }}>
              <h2 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '16px', color: 'var(--accent)' }}>
                üî¥ Ongoing
              </h2>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {ongoing.map(c => <CompCard key={c.id} comp={c} />)}
              </div>
            </div>
          )}
          
          {upcoming.length > 0 && (
            <div style={{ marginBottom: '32px' }}>
              <h2 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '16px' }}>
                üìÖ Upcoming
              </h2>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {upcoming.map(c => <CompCard key={c.id} comp={c} />)}
              </div>
            </div>
          )}
          
          {past.length > 0 && (
            <div>
              <h2 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '16px', color: 'var(--text-muted)' }}>
                üìú Past
              </h2>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {past.map(c => <CompCard key={c.id} comp={c} />)}
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
};

// ============================================
// MAIN APP
// ============================================

function App() {
  const [groupId, setGroupId] = useState(() => {
    const saved = storage.getLastGroup();
    return saved ? parseInt(saved) : null;
  });
  const [group, setGroup] = useState(null);
  const [members, setMembers] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [page, setPage] = useState('dashboard');
  const [selectedPlayer, setSelectedPlayer] = useState(null);
  
  const joinGuild = async (id) => {
    setLoading(true);
    setError('');
    try {
      const groupData = await api.getGroup(id);
      const membersData = await api.getGroupMembers(id);
      setGroup(groupData);
      setMembers(membersData);
      setGroupId(id);
      storage.setLastGroup(id);
    } catch (e) {
      setError(e.message);
      throw e;
    } finally {
      setLoading(false);
    }
  };
  
  useEffect(() => {
    if (groupId && !group) {
      joinGuild(groupId).catch(() => {
        setGroupId(null);
        localStorage.removeItem('last_group_id');
      });
    }
  }, [groupId]);
  
  if (loading) {
    return (
      <div style={{
        minHeight: '100vh',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        flexDirection: 'column',
        gap: '16px',
      }}>
        <Spinner />
        <span style={{ color: 'var(--text-muted)' }}>Loading guild data...</span>
      </div>
    );
  }
  
  if (!groupId || !group) {
    return <LandingPage onJoinGuild={joinGuild} />;
  }
  
  const renderPage = () => {
    switch (page) {
      case 'dashboard': return <DashboardPage />;
      case 'members': return <MembersPage setPage={setPage} setSelectedPlayer={setSelectedPlayer} />;
      case 'player': return <PlayerPage player={selectedPlayer} setPage={setPage} />;
      case 'leaderboards': return <LeaderboardsPage />;
      case 'goals': return <GoalsPage />;
      case 'competitions': return <CompetitionsPage />;
      default: return <DashboardPage />;
    }
  };
  
  return (
    <GuildContext.Provider value={{ group, members }}>
      <Nav currentPage={page} setPage={setPage} />
      {renderPage()}
    </GuildContext.Provider>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
